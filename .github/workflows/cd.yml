name: CD - Build & Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ${{ github.repository }}/backend

jobs:
  # ============================================================================
  # Wait for CI to pass
  # ============================================================================
  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI workflow
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'Integration - Health Check'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
          allowed-conclusions: success

  # ============================================================================
  # Build Backend Docker Image
  # ============================================================================
  build-backend:
    name: Build Backend Image
    runs-on: ubuntu-latest
    needs: wait-for-ci
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  # ============================================================================
  # Deploy Frontend to Vercel
  # ============================================================================
  deploy-frontend-staging:
    name: Deploy Frontend to Vercel (Staging)
    runs-on: ubuntu-latest
    needs: wait-for-ci
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend
          vercel-args: '--env NEXT_PUBLIC_API_URL=${{ vars.STAGING_API_URL }}'

      - name: Output deployment URL
        run: |
          echo "Frontend deployed to: ${{ steps.deploy.outputs.url }}"

  deploy-frontend-production:
    name: Deploy Frontend to Vercel (Production)
    runs-on: ubuntu-latest
    needs: [deploy-frontend-staging, deploy-backend-staging]
    if: github.event.inputs.environment == 'production'
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Vercel Production
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend
          vercel-args: '--prod --env NEXT_PUBLIC_API_URL=${{ vars.PRODUCTION_API_URL }}'

      - name: Output deployment URL
        run: |
          echo "Frontend deployed to: ${{ steps.deploy.outputs.url }}"

  # ============================================================================
  # Deploy Backend to Railway (Staging)
  # ============================================================================
  deploy-backend-staging:
    name: Deploy Backend to Railway (Staging)
    runs-on: ubuntu-latest
    needs: build-backend
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: ${{ vars.STAGING_API_URL }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy Backend to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Deploying backend to Railway staging..."
          railway link ${{ vars.RAILWAY_STAGING_PROJECT_ID }}
          cd backend
          railway up --service backend --detach
          echo "Backend deployment initiated"

      - name: Run Database Migrations
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Running database migrations..."
          railway link ${{ vars.RAILWAY_STAGING_PROJECT_ID }}
          railway run --service backend -- alembic upgrade head
          echo "Migrations complete"

      - name: Wait for deployment
        run: |
          echo "Waiting for services to be ready..."
          sleep 30

  # ============================================================================
  # Deploy Backend to Railway (Production)
  # ============================================================================
  deploy-backend-production:
    name: Deploy Backend to Railway (Production)
    runs-on: ubuntu-latest
    needs: [deploy-backend-staging, build-backend]
    if: github.event.inputs.environment == 'production'
    environment:
      name: production
      url: ${{ vars.PRODUCTION_API_URL }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy Backend to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Deploying backend to Railway production..."
          railway link ${{ vars.RAILWAY_PRODUCTION_PROJECT_ID }}
          cd backend
          railway up --service backend --detach
          echo "Backend deployment initiated"

      - name: Run Database Migrations
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Running database migrations..."
          railway link ${{ vars.RAILWAY_PRODUCTION_PROJECT_ID }}
          railway run --service backend -- alembic upgrade head
          echo "Migrations complete"

      - name: Wait for deployment
        run: |
          echo "Waiting for services to be ready..."
          sleep 30

  # ============================================================================
  # Post-Deployment Verification
  # ============================================================================
  verify-staging:
    name: Verify Staging Deployment
    runs-on: ubuntu-latest
    needs: [deploy-frontend-staging, deploy-backend-staging]
    if: always() && needs.deploy-backend-staging.result == 'success'
    steps:
      - name: Wait for services to stabilize
        run: sleep 60

      - name: Health check - Backend API
        run: |
          echo "Checking backend API health..."
          BACKEND_URL="${{ vars.STAGING_API_URL }}/health"
          echo "Checking: $BACKEND_URL"

          for i in {1..10}; do
            if curl --fail --silent --max-time 10 "$BACKEND_URL" > /dev/null; then
              echo "Backend API is healthy"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 15s..."
            sleep 15
          done

          echo "Backend health check failed after 10 attempts"
          exit 1

      - name: Health check - Frontend
        run: |
          echo "Checking frontend health..."
          FRONTEND_URL="${{ vars.STAGING_URL }}"
          echo "Checking: $FRONTEND_URL"

          for i in {1..10}; do
            if curl --fail --silent --max-time 10 "$FRONTEND_URL" > /dev/null; then
              echo "Frontend is healthy"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 15s..."
            sleep 15
          done

          echo "Frontend health check failed after 10 attempts"
          exit 1

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          BACKEND_URL="${{ vars.STAGING_API_URL }}"

          # Test API docs endpoint
          echo "Testing API docs..."
          curl --fail --silent "$BACKEND_URL/docs" > /dev/null && echo "API docs accessible"

          # Test auth endpoints exist
          echo "Testing auth endpoint..."
          STATUS=$(curl --silent --write-out "%{http_code}" --output /dev/null "$BACKEND_URL/api/auth/login" -X POST -H "Content-Type: application/json" -d '{}')
          if [ "$STATUS" = "422" ] || [ "$STATUS" = "400" ]; then
            echo "Auth endpoint responding (validation error expected)"
          else
            echo "Auth endpoint returned: $STATUS"
          fi

          echo "Smoke tests complete"

      - name: Deployment summary
        if: always()
        run: |
          echo "=========================================="
          echo "Deployment Verification Summary"
          echo "=========================================="
          echo "Environment: staging"
          echo "Frontend URL: ${{ vars.STAGING_URL }}"
          echo "API URL: ${{ vars.STAGING_API_URL }}"
          echo "Status: ${{ job.status }}"
          echo "=========================================="

  # ============================================================================
  # Rollback Instructions
  # ============================================================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && failure()
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
    steps:
      - name: Rollback instructions
        run: |
          echo "Rollback Instructions"
          echo "====================="
          echo ""
          echo "BACKEND (Railway):"
          echo "1. Go to Railway Dashboard"
          echo "2. Select the backend service"
          echo "3. Click Deployments tab"
          echo "4. Find the last successful deployment"
          echo "5. Click 'Redeploy'"
          echo ""
          echo "FRONTEND (Vercel):"
          echo "1. Go to Vercel Dashboard"
          echo "2. Select the project"
          echo "3. Click Deployments tab"
          echo "4. Find the last successful deployment"
          echo "5. Click '...' menu -> 'Promote to Production'"

  # ============================================================================
  # Deployment Notification
  # ============================================================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [verify-staging]
    if: always()
    steps:
      - name: Notify on success
        if: needs.verify-staging.result == 'success'
        run: |
          echo "Deployment completed successfully!"
          echo "Environment: ${{ github.event.inputs.environment || 'staging' }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"

      - name: Notify on failure
        if: needs.verify-staging.result == 'failure'
        run: |
          echo "Deployment verification failed!"
          echo "Environment: ${{ github.event.inputs.environment || 'staging' }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "Please check the logs and consider rolling back."
