name: CD - Build & Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ${{ github.repository }}/backend
  FRONTEND_IMAGE: ${{ github.repository }}/frontend

jobs:
  # ============================================================================
  # Wait for CI to pass
  # ============================================================================
  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI workflow
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'Integration - Health Check'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
          allowed-conclusions: success

  # ============================================================================
  # Build and Push Docker Images
  # ============================================================================
  build-backend:
    name: Build Backend Image
    runs-on: ubuntu-latest
    needs: wait-for-ci
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  build-frontend:
    name: Build Frontend Image
    runs-on: ubuntu-latest
    needs: wait-for-ci
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
          build-args: |
            NEXT_PUBLIC_API_URL=${{ vars.NEXT_PUBLIC_API_URL || 'http://localhost:8000' }}

  # ============================================================================
  # Deploy to Staging (Railway)
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: ${{ vars.STAGING_URL }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy Backend to Railway Staging
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üöÄ Deploying backend to Railway staging..."
          railway link ${{ vars.RAILWAY_STAGING_PROJECT_ID }}
          cd backend
          railway up --service backend --detach
          echo "‚úÖ Backend deployment initiated"

      - name: Deploy Frontend to Railway Staging
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üöÄ Deploying frontend to Railway staging..."
          railway link ${{ vars.RAILWAY_STAGING_PROJECT_ID }}
          cd frontend
          railway up --service frontend --detach
          echo "‚úÖ Frontend deployment initiated"

      - name: Run Database Migrations
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üóÑÔ∏è Running database migrations..."
          railway link ${{ vars.RAILWAY_STAGING_PROJECT_ID }}
          railway run --service backend -- alembic upgrade head
          echo "‚úÖ Migrations complete"

      - name: Wait for deployment to be ready
        run: |
          echo "‚è≥ Waiting for services to be ready..."
          sleep 30
          echo "‚úÖ Deployment wait complete"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Staging deployment successful"
          else
            echo "‚ùå Staging deployment failed"
          fi

  # ============================================================================
  # Deploy to Production (Manual Approval Required)
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging, build-backend, build-frontend]
    if: github.event.inputs.environment == 'production'
    environment:
      name: production
      url: ${{ vars.PRODUCTION_URL }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy Backend to Railway Production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üöÄ Deploying backend to Railway production..."
          railway link ${{ vars.RAILWAY_PRODUCTION_PROJECT_ID }}
          cd backend
          railway up --service backend --detach
          echo "‚úÖ Backend deployment initiated"

      - name: Deploy Frontend to Railway Production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üöÄ Deploying frontend to Railway production..."
          railway link ${{ vars.RAILWAY_PRODUCTION_PROJECT_ID }}
          cd frontend
          railway up --service frontend --detach
          echo "‚úÖ Frontend deployment initiated"

      - name: Run Database Migrations
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üóÑÔ∏è Running database migrations..."
          railway link ${{ vars.RAILWAY_PRODUCTION_PROJECT_ID }}
          railway run --service backend -- alembic upgrade head
          echo "‚úÖ Migrations complete"

      - name: Wait for deployment to be ready
        run: |
          echo "‚è≥ Waiting for services to be ready..."
          sleep 30
          echo "‚úÖ Deployment wait complete"

  # ============================================================================
  # Post-Deployment Verification
  # ============================================================================
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: always() && needs.deploy-staging.result == 'success'
    steps:
      - name: Wait for services to stabilize
        run: sleep 60

      - name: Health check - Backend API
        run: |
          echo "üîç Checking backend API health..."
          BACKEND_URL="${{ vars.STAGING_API_URL }}/health"
          echo "Checking: $BACKEND_URL"

          for i in {1..10}; do
            if curl --fail --silent --max-time 10 "$BACKEND_URL" > /dev/null; then
              echo "‚úÖ Backend API is healthy"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 15s..."
            sleep 15
          done

          echo "‚ùå Backend health check failed after 10 attempts"
          exit 1

      - name: Health check - Frontend
        run: |
          echo "üîç Checking frontend health..."
          FRONTEND_URL="${{ vars.STAGING_URL }}"
          echo "Checking: $FRONTEND_URL"

          for i in {1..10}; do
            if curl --fail --silent --max-time 10 "$FRONTEND_URL" > /dev/null; then
              echo "‚úÖ Frontend is healthy"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 15s..."
            sleep 15
          done

          echo "‚ùå Frontend health check failed after 10 attempts"
          exit 1

      - name: Run smoke tests
        run: |
          echo "üß™ Running smoke tests..."
          BACKEND_URL="${{ vars.STAGING_API_URL }}"

          # Test API docs endpoint
          echo "Testing API docs..."
          curl --fail --silent "$BACKEND_URL/docs" > /dev/null && echo "‚úÖ API docs accessible"

          # Test auth endpoints exist
          echo "Testing auth endpoint..."
          STATUS=$(curl --silent --write-out "%{http_code}" --output /dev/null "$BACKEND_URL/api/auth/login" -X POST -H "Content-Type: application/json" -d '{}')
          if [ "$STATUS" = "422" ] || [ "$STATUS" = "400" ]; then
            echo "‚úÖ Auth endpoint responding (validation error expected)"
          else
            echo "‚ö†Ô∏è Auth endpoint returned: $STATUS"
          fi

          echo "‚úÖ Smoke tests complete"

      - name: Deployment summary
        if: always()
        run: |
          echo "=========================================="
          echo "üìä Deployment Verification Summary"
          echo "=========================================="
          echo "Environment: staging"
          echo "Frontend URL: ${{ vars.STAGING_URL }}"
          echo "API URL: ${{ vars.STAGING_API_URL }}"
          echo "Status: ${{ job.status }}"
          echo "=========================================="

  # ============================================================================
  # Rollback (Manual Trigger Only)
  # ============================================================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && failure()
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Rollback to previous deployment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üîÑ Rolling back deployment..."
          ENV="${{ github.event.inputs.environment || 'staging' }}"

          if [ "$ENV" = "production" ]; then
            PROJECT_ID="${{ vars.RAILWAY_PRODUCTION_PROJECT_ID }}"
          else
            PROJECT_ID="${{ vars.RAILWAY_STAGING_PROJECT_ID }}"
          fi

          railway link "$PROJECT_ID"

          # Railway automatically keeps previous deployments
          # This redeploys the previous successful version
          echo "‚ö†Ô∏è Manual rollback required via Railway dashboard"
          echo "1. Go to https://railway.app/project/$PROJECT_ID"
          echo "2. Select the service to rollback"
          echo "3. Click on Deployments tab"
          echo "4. Find the last successful deployment"
          echo "5. Click 'Redeploy' on that deployment"

          echo "‚úÖ Rollback instructions provided"

  # ============================================================================
  # Deployment Notification
  # ============================================================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [verify-deployment]
    if: always()
    steps:
      - name: Notify on success
        if: needs.verify-deployment.result == 'success'
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "Environment: ${{ github.event.inputs.environment || 'staging' }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"

          # Add notification integrations here:
          # - Slack: curl -X POST -H 'Content-type: application/json' --data '{"text":"..."}' $SLACK_WEBHOOK
          # - Discord: curl -X POST -H 'Content-type: application/json' --data '{"content":"..."}' $DISCORD_WEBHOOK

      - name: Notify on failure
        if: needs.verify-deployment.result == 'failure'
        run: |
          echo "‚ùå Deployment verification failed!"
          echo "Environment: ${{ github.event.inputs.environment || 'staging' }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "Please check the logs and consider rolling back."
