name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --dev

      - name: Check formatting with Black
        run: uv run black --check --diff .

      - name: Check import sorting with isort
        run: uv run isort --check-only --diff .

      - name: Run Pylint
        run: uv run pylint services/ utils/ models/ --exit-zero --output-format=colorized

  test:
    name: Test (Mock Provider)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --dev

      - name: Run tests with mock LLM provider
        env:
          LLM_PROVIDER: mock
        run: uv run python test_app.py

  test-openai:
    name: Test (OpenAI)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --dev

      - name: Run tests with OpenAI
        if: env.OPENAI_API_KEY != ''
        env:
          LLM_PROVIDER: openai
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: uv run python test_app.py

  test-anthropic:
    name: Test (Anthropic)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: |
          uv sync --dev
          uv add langchain-anthropic

      - name: Run tests with Anthropic
        if: env.ANTHROPIC_API_KEY != ''
        env:
          LLM_PROVIDER: anthropic
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: uv run python test_app.py

  test-google:
    name: Test (Google)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: |
          uv sync --dev
          uv add langchain-google-genai

      - name: Run tests with Google
        if: env.GOOGLE_API_KEY != ''
        env:
          LLM_PROVIDER: google
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: uv run python test_app.py

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.11

      - name: Install Bandit
        run: uv tool install bandit

      - name: Run Bandit security scan
        run: uv tool run bandit -r services/ utils/ models/ -ll -ii
